<!DOCTYPE html><html><head><title>Yet Another Doom Clone</title></head><body><style>body{margin:0px;background:#000}#qQ{position:absolute;left:35vw;top:4em;font-size:2em;font-variant:small-caps;color:#aaa;animation:z 9s;}#cQ{height:100%;width:100%}#hQ{top:0px;width:10vw;height:2vh;border:3px solid #008;border-radius:3px;display:none}#fps{display:none}#hW{height:2vh;background:#00a}@keyframes q{50%{opacity:0}}.b{animation:q 1s linear infinite}@keyframes z{from{opacity:0}to{opacity:1}}</style><canvas id=cQ></canvas><div id=qQ><div id=hE>Yet Another Doom Clone<br><br><div class=b>Loading... <span id=jQ></span></div><br><br>Move: WASD<br>Aim/Shoot: Mouse/Click<br><br><br><br>By Nicholas Carlini</div><div id=hQ><div id=hW></div></div></div></body>
<script src="src/shaders/program1.js"></script>
<script>class SfxrSynth{constructor(){var a,r,e,t,s,n,h,m,c,i;this._params={},this.reset=()=>{var a=this._params;r=100/(a.f**2+.001),e=100/(a.g**2+.001),t=1-a.h**3*.01,s=1e-6*-(a.i**3),3==a.a&&(c=.5-a.n/2,i=5e-5*-a.o),n=1+a.l**2*(a.l>0?-.9:10),h=0,m=1==a.m?0:(1-a.m)**2*2e4+32},this.totalReset=()=>{this.reset();var r=this._params;return a=[r.b**2*1e5,r.c**2*1e5,r.e**2*1e5,1],sum(a)},this.synthWave=(p,v)=>{var l=this._params,u=1!=l.s||l.v,o=l.v**2*.1,f=1+3e-4*l.w,g=l.s**3*.1,d=l.x**2,x=l.q||l.r,y=l.q**2*(l.q<0?-1020:1020),S=l.p?32+((1-l.p)**2*2e4|0):0,_=l.j/2,M=l.a,b=a[0],q=5/(1+l.u**2*20)*(.01+g);q=1-clamp(q,0,.8);var w,j,C,N,R=!1,W=0,k=0,A=0,z=0,B=0,D=0,E=0,F=0,G=0,H=0,I=0,J=new Array(1024),K=range(32).map((a=>urandom()));J.fill(0);for(var L=0;L<v;L++){if(R)return L;S&&++G>=S&&(G=0,this.reset()),m&&++h>=m&&(m=0,r*=n),(r*=t+=s)>e&&(r=e,R=l.g>0),j=r,_>0&&(I+=l.k**2*.01,j*=1+Math.sin(I)*_),j=0|clamp(j,8,1e9),3==M&&(c=clamp(c+i,0,.5)),++k>b&&(k=0,b=a[++W]);var O=k/a[W];A=[O,1+2*(1-O)*l.d,1-O,0][W],R|=3==W,x&&(y+=l.r**3*.2,(C=0|y)<0?C=-C:C>1023&&(C=1023)),u&&f&&(o=clamp(o*f,1e-5,.1)),p[L]=sum(range(8).map((a=>(++E>=j&&(E%=j,M<=1&&range(K.length).map((a=>{1==M?(K[a]=H=(H+.02*urandom())/1.02,K[a]*=3.5):K[a]=urandom()}))),N=[K[Math.abs(32*E/j|0)],K[Math.abs(32*E/j|0)],NaN,E/j<c?.5:-.5,N=1-E/j*2][M],u&&(w=D,g=clamp(g*(1+1e-4*l.t),0,.1),1!=l.s?(B+=(N-D)*g,B*=q):(D=N,B=0),z+=(D+=B)-w,N=z*=1-o),x&&(J[F%1024]=N,N+=J[(F-C+1024)%1024],F++),N))))*A*d*(.5+1.5*(1==M))}return v}}}var cache={};function jsfxr(a){if(cache[a])return cache[a];var r=new SfxrSynth,e=r._params;range(24).map((r=>e[String.fromCharCode(97+r)]=a[r]||0)),e.c=Math.max(e.c,.01);var t=r.totalReset(),s=range(0|t);return r.synthWave(s,t),cache[a]=s}
</script>
<script>
  var musicnotes,sounds={},context=new AudioContext,play=(t,n)=>{var a=context.createBuffer(1,t.length,48e3);a.copyToChannel(new Float32Array(t),0,0);var o=context.createBufferSource(),e=context.createStereoPanner();return o.buffer=a,o.connect(e),e.pan.value=n?Math.cos(angle_between(n,camera.position)+camera.theta+Math.PI/2):0,e.connect(context.destination),o.start(),o},music_timeouts=[];function doplay(){music_timeouts.length<2&&!going_back&&can_play_music&&musicnotes.map(((t,n)=>t.map((t=>music_timeouts.push(setTimeout((n=>{music_timeouts.shift(),play(t,NewVector(20,-40,0)),1==music_timeouts.length&&doplay()}),200*n+400))))))}var arr,toaudio=t=>transpose(t).map(sum);function load(){var t=[null,19,17,19,15,19,14,19,12,19,11,19,12,19,14,19,15,19,7,19,9,19,11,19,12,19,11,19,12,19,14,19],n=[[0,1,1,t],[5,1,2,t,[15,16,17,10,8,7,8,10,12,4,5,7,8,7,8,4]],[0,2,1,[20,24,20,24,25,17,25,17,22,19,22,19,24,15,24,15,20,17,20,17,23,14,23,14,19,15,19,15,17,11,17,11,15,12,15,12,14,8,14,8],[5,17,5,17,12,17,12,17,10,13,10,13,10,13,10,13,10,15,10,15,10,15,10,15,8,12,8,12,8,12,8,12,8,14,8,14,8,14,8,14,7,11,7,11,7,11,7,11,3,12,3,12,3,12,3,12,2,8,2,8,2,8,2,8,0,19,0,19,0,19,0,19,2,5,2,5,2,5,2,5]],[12,1,2,t,[3,2,0,5,3,2,3,-1,0,-1,0,2,3,2,3,-1]],[12,1,4,[15,19,14,19,12,19,10,19,8,19,10,19,12,17,20,17,14,17,12,17,10,17,20,17,7,17,8,17,10,15,7,15,12,15,10,15,8,15,7,15,5,15,19,15,8,14,5,14,11,14,8,14,7,14,5,14,3,14,5,14],[7,12,12,null,10,10,10,null,9,9,9,null,7,7,7],[0,3,5,null,-2,2,3,null,-4,0,2,null,-5,-1,12]],[0,1,2,[19,24,15,24,14,26,14,26,15,24,15,24,20,23,20,23,19,24,15,24,14,26,14,26,15,24,15,24],[null,12,11,11,12,12,14,null,null,12,11,11,12,12,14],[null,3,8,8,7,7,17,null,null,7,8,8,7,7,6]]];musicnotes=range(300).map((t=>[]));var a=0,o=t=>{var[e,r,u,...s]=n.shift();s.map(((t,o)=>t.map(((t,s)=>((t,n,o,e)=>{if(null!=n){var r=.11*e+.13;musicnotes[o+a].push(toaudio([n/12,n/12-1].map((n=>(n=2**(n/2)*.25,t?jsfxr([3,.1,r,.1,.3,n,,,,,,,,.5,,,-1,,.2,,,,,.1]):jsfxr([3,.1,r+.07,.3,.5,n,,,,,,,,,,,,,.15,,,,,.1]))))))}})(!o&&n.length<5,null==t?null:t+e*!o,s*(o?u:r),o?u:r))))),a+=r*s[0].length,jQ.innerHTML=6-n.length+"/6",setTimeout(n.length?o:main_go,1)};setTimeout(o,1)}function setup_audio(){load(),arr=[100,7,55,25,35,20,,15,,,4,,,,2,33,-8,-23,20,,23,4,-48,30,100,,5,100,55,20,,,-10,,,,,,,,-40,-5,15,,,,,30,,,5,100,55,20,,,-10,,,,,,,,-40,-5,15,,,,,30,300,10,25,5,20,25,10,,,50,,,,50,,,,,10,,50,50,,60,300,5,15,5,20,25,10,,,50,,,,50,,,,,10,,50,50,,60,300,45,55,,55,15,,-10,,,,,,,,,,,25,,,,,30,0,5,5,,45,5,,-10,,,,,,,,,-25,,5,,,,,300],arr=reshape(arr.map((t=>t/100)),24),sounds.boom=toaudio([jsfxr(arr[0])]),sounds.gun=toaudio([jsfxr(arr[1]),jsfxr(arr[2])]),sounds.collect=toaudio([jsfxr(arr[3])]),sounds.collect2=toaudio([jsfxr(arr[4])]),sounds.clock=toaudio([jsfxr(arr[5]),jsfxr(arr[5]).slice(2e3)]),sounds.hit=toaudio([jsfxr(arr[6]),jsfxr(arr[1])])}
  </script>
<script>
    var LOCAL0,LOCAL1,LOCAL2,pairs=(t,r)=>t.slice(0,-1).map(((e,a)=>r(e,t[a+1],a))),transpose=t=>t[0].map(((r,e)=>t.map((t=>t[e])))),range=(t,r)=>Array(t).fill().map(((t,e)=>e+(r||0))),reshape=(t,r)=>range(t.length/r).map((e=>t.slice(e*r,(e+1)*r))),urandom=t=>2*Math.random()-1,urandom_vector=t=>NewVector(urandom(),urandom(),urandom()),multiply,mat_vector_product;function uncompress(t){return atob(t).split("").map((t=>t.charCodeAt(0)))}var cartesian_product_map=(t,r,e)=>[].concat(...t.map((t=>r.map((r=>e(t,r)))))),normal_to_plane=(t,r,e)=>t.subtract(r).cross(e.subtract(r))._normalize(),NewVector=(t,r,e)=>new Vector(t,r,e),NewVectorFromList=t=>NewVector(...t),reduce_add=t=>t.reduce(((t,r)=>t.add(r))),reduce_mean=t=>reduce_add(t).scalar_multiply(1/t.length),angle_between=(t,r)=>Math.atan2(t.subtract(r).x,t.subtract(r).y),push=(t,r)=>(t.push(r),t),clamp=(t,r,e)=>Math.min(Math.max(r,t),e),sum=t=>t.reduce(((t,r)=>t+r)),matrix_rotate_yz=t=>[1,0,0,0,0,Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1],matrix_rotate_xz=t=>[Math.cos(t),0,-Math.sin(t),0,0,1,0,0,Math.sin(t),0,Math.cos(t),0,0,0,0,1],matrix_rotate_xy=t=>[Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1,0,0,0,0,1],matrix_translate=t=>[1,0,0,t[0],0,1,0,t[1],0,0,1,t[2],0,0,0,1],IDENTITY=matrix_translate([0,0,0]);class Vector{constructor(t,r,e){this.x=+t||0,this.y=+r||0,this.z=+e||0}add(t){return NewVector(this.x+t.x,this.y+t.y,this.z+t.z)}subtract(t){return this.add(t.negate())}negate(){return this.scalar_multiply(-1)}scalar_multiply(t){return NewVector(this.x*t,this.y*t,this.z*t)}vector_multiply(t){return NewVector(this.x*t.x,this.y*t.y,this.z*t.z)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}_xyz(){return[this.x,this.y,this.z]}_xyzw(){return push(this._xyz(),0)}lerp(t,r){return this.scalar_multiply(1-r).add(t.scalar_multiply(r))}cross(t){return NewVector(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}copy(){return NewVectorFromList(this._xyz())}length_squared(){return this.dot(this)}vector_length(){return this.length_squared()**.5}distance_to(t){return this.subtract(t).vector_length()}noz(){return NewVector(this.x,this.y,0)}_normalize(){return this.scalar_multiply(1/(this.vector_length()+1e-30))}id(){return""+this._xyz().map((t=>t.toFixed(4)))}}function ray_line_intersect(t,r,e,a){var s=t.subtract(e),o=a.subtract(e),i=NewVector(-r.y,r.x,0);if(e=(o.x*s.y-o.y*s.x)/o.dot(i),a=s.dot(i)/o.dot(i),e>=0&&a>=0&&a<=1)return[e,a]}var ZERO=new Vector(0,0,0),X_DIR=NewVector(1,0,0),Y_DIR=NewVector(0,1,0),Z_DIR=NewVector(0,0,1),X_AXIS=1,Y_AXIS=2,Z_AXIS=4;function merge_sprites(t){var r=[],e=[],a=[];return t.map((t=>{r.push(reshape(Array.from(t.a_positions),3).map((r=>mat_vector_product(t.rotation,NewVectorFromList(r)).add(t.position)._xyz()))),e.push(reshape(Array.from(t.a_normals),3).map((r=>mat_vector_product(t.rotation,NewVectorFromList(r))._normalize()._xyz()))),a.push(Array.from(t.a_colors))})),new Sprite([r.flat(2),e.flat(2)],ZERO,IDENTITY,!1,a.flat())}class Sprite{constructor(t,r,e,a,s,o){this.a_positions=new Float32Array(t[0]),this.a_normals=new Float32Array(t[1]),this.aq_angle=new Float32Array(t[0].map((t=>Math.PI/2))),this.position=r,this.buffers=[gl.createBuffer(),gl.createBuffer(),gl.createBuffer(),gl.createBuffer()],this.rotation=e||IDENTITY,this.transparent=a,s=s||[1,1,1],this.a_colors=new Float32Array(s.length==t[0].length?s:Array(t[0].length/3).fill(s).flat()),[this._texture,this.texture_direction]=o||[0,0],this.rebuffer()}rebuffer(){[this.a_positions,this.a_normals,this.a_colors,this.aq_angle].map(((t,r)=>{gl.bindBuffer(gl.ARRAY_BUFFER,this.buffers[r]),gl.bufferData(gl.ARRAY_BUFFER,t,gl.DYNAMIC_DRAW)}))}render(){this.transparent&&locations==locations2||(gl.uniform4fv(locations.u_world_position,this.position.negate()._xyzw()),gl.uniformMatrix4fv(locations.u_world_rotation,!1,this.rotation),[locations.a_position,locations.a_normal,locations.a_color,locations.a_angle].map(((t,r)=>{void 0!==t&&-1!==t&&(gl.enableVertexAttribArray(t),gl.bindBuffer(gl.ARRAY_BUFFER,this.buffers[r]),gl.vertexAttribPointer(t,3,gl.FLOAT,!1,0,0))})),gl.uniform1i(locations.u_render_texture,this.texture_direction),gl.uniform1i(locations.u_texture_mux,this._texture-20),gl.uniform1i(locations.u_render_direct,this.transparent),gl.drawArrays(gl.TRIANGLES,0,this.a_positions.length/3))}}var setup_utils=()=>{var mat_product_symbolic=t=>`(a,b)=>[${reshape(range(16),4).map((r=>t[0].map(((e,a)=>t.reduce(((t,e,s)=>`${t}+b[${e[a]}]*a[${r[s]}]`),0))))).flat()}]`;multiply=eval(mat_product_symbolic(reshape(range(16),4)));var mat_vector_product_q=eval(mat_product_symbolic(reshape(range(4),1)));mat_vector_product=(t,r)=>NewVectorFromList(mat_vector_product_q(t,r._xyzw()))};
    </script>
<script>function lathe(a,e,r,p,t){var m=ZERO;a=reshape(a,2).map((a=>m=NewVector(0,...a).add(m)));var n=range(e).map((r=>a.map((a=>mat_vector_product(matrix_rotate_xy(2*Math.PI/e*r),a))))).flat(),_=a.length,u=cartesian_product_map(range(_-1),range(e),((a,e)=>[0+a+e*_,1+a+e*_,_+1+a+e*_,_+a+e*_]));return p&&(u.push(range(e).map((a=>a*_))),u.push(range(e).reverse().map((a=>a*_+_-1)))),n=n.map(t||(a=>a)),make_output_from_faces(u=u.map((a=>a.map((a=>n[a%n.length])))))}function make_output_from_faces(a){var e=[],r=[],p={};return a.map((a=>pairs(a,((e,r)=>[a[0],e,r])).slice(1))).flat(1).map((a=>{var t=normal_to_plane(...a);a.map(((a,e)=>p[a.id()]=push(p[a.id()]||[],r.length+e))),e.push(...a),r.push(t,t,t)})),e.map((a=>{var e=p[a.id()],t=e.map((a=>r[a])),m=reduce_mean(t);t.every((a=>m.dot(a)>.8))&&e.map((a=>r[a]=m))})),[e.map((a=>a._xyz())).flat(),r.map((a=>a._xyz())).flat()]}
</script>
<script>
  var fragmentShaderHeader=`#version 300 es\nprecision mediump float;\n\nin vec4 v_normal,world_position,v_color,v_angle,v_project_onto_light[5];\n\nuniform bool u_render_direct,u_is_light_shadow[5];\nuniform int u_which_shadow_light,u_texture_mux,u_render_texture;\nuniform vec4 u_shift_color,u_light_position[5];\nuniform float u_ambient_light,u_light_brightness[5];\nuniform sampler2D u_texture[9];\n\nout vec4 out_color;\n\nvec4 get_shader(int i, vec2 texpos) {\n  switch(i) {\n  ${range(9).map((e=>"case "+e+":return texture(u_texture["+e+"],texpos)")).join(";")};\n  }\n}`;function createShader(e,t,r){var a=e.createShader(t);if(e.shaderSource(a,r),e.compileShader(a),e.getShaderParameter(a,e.COMPILE_STATUS))return a;console.log(r.split("\n").map(((e,t)=>t+1+":"+e)).join("\n")),console.log(e.getShaderInfoLog(a)),e.deleteShader(a)}function createProgram(e,t){var r=e.createProgram(),a="#version 300 es\nprecision mediump float;\n\nin vec4 a_position,a_normal,a_color,a_angle;\n\nout vec4 v_normal,world_position,v_color,v_angle;\nout vec4 v_project_onto_light[5];\n\nuniform vec4 u_world_position,u_light_position[5];\nuniform mat4 u_world_rotation,u_light_matrix[5];\n\n\nvoid main() {\n  world_position = a_position * u_world_rotation - u_world_position;\n  v_normal = a_normal * u_world_rotation;\n\n  for (int i = 0; i < 5; i++) {\n    gl_Position = v_project_onto_light[i] = u_light_matrix[i] * world_position;\n  }\n  v_color = a_color;\n  v_angle = a_angle;\n}\n";if(e.attachShader(r,createShader(e,e.VERTEX_SHADER,a)),e.attachShader(r,createShader(e,e.FRAGMENT_SHADER,t)),e.linkProgram(r),e.getProgramParameter(r,e.LINK_STATUS)){var i={},o=!0;return(fragmentShaderHeader+a).match(/[a-zA-Z_]+(\[[0-9]\])?/g).map((t=>{var a=[t];t.indexOf("[")>0&&(a=range(32).map((e=>t.replace(/[0-9]/,e)))),"in"==t&&(o=!0),"uniform"==t&&(o=!1),a.map((t=>i[t]=i[t]||(o?e.getAttribLocation(r,t):e.getUniformLocation(r,t))))})),[r,i]}console.log(e.getProgramInfoLog(r)),e.deleteProgram(r)}function make_proj_matrix(e,t,r,a){var i=Math.tan(Math.PI/2-e/2);return[[i/t,0,0,0,0,0,i,0,0,1,0,0,0,1,0,1],r,matrix_translate(a.negate()._xyz())].reduce(multiply)}class Camera{constructor(e,t,r,a,i,o,n){this.position=e,this.dimensions=t,this.theta=o||0,this.theta2=n||0,this.theta3=0,this.cull=gl.FRONT,this.camera_is_light=a,this.fov=r,this.aspect=t[0]/t[1],this.shadow_camera=this,this.texture_id=i,[this._texture,this.framebuffer]=setup_framebuffer(i,a,...t)}draw_scene(){gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffer),all_textures.map(((e,t)=>{gl.activeTexture(gl.TEXTURE19+t),gl.bindTexture(gl.TEXTURE_2D,e),gl.uniform1i(locations[`u_texture[${t+4}]`],t+19)})),push(lights.slice(0,4),this).map(((e,t)=>{gl.uniform4fv(locations[`u_light_position[${t}]`],e.position._xyzw()),gl.uniformMatrix4fv(locations[`u_light_matrix[${t}]`],!0,make_proj_matrix(e.shadow_camera.fov,e.shadow_camera.aspect,[matrix_rotate_xz(e.shadow_camera.theta3),matrix_rotate_yz(e.shadow_camera.theta2),matrix_rotate_xy(e.shadow_camera.theta)].reduce(multiply),e.shadow_camera.position)),4!=t&&(this.camera_is_light||(gl.activeTexture(gl.TEXTURE0+e.id),gl.bindTexture(gl.TEXTURE_2D,e.filter._texture),gl.uniform1i(locations[`u_texture[${t}]`],e.id)),gl.uniform1i(locations[`u_is_light_shadow[${t}]`],e.shadow),gl.uniform1f(locations[`u_light_brightness[${t}]`],e.brightness))})),!going_back||framecount++%200<10?(gl.uniform1f(locations.u_ambient_light,.05),lights[0].brightness=1.2,lights[1].brightness=1.2,lights[2].brightness=1.5,lights[3].brightness=4):(gl.uniform1f(locations.u_ambient_light,1e-4),lights[0].brightness=7,lights[1].brightness=0,lights[2].brightness=8,lights[3].brightness=30),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.enable(gl.DEPTH_TEST),this.cull&&(gl.enable(gl.CULL_FACE),gl.cullFace(this.cull)),gl.viewport(0,0,this.dimensions[0],this.dimensions[1]),objects.map((e=>{this.camera_is_light&&e.gc||e.render()})),gl.bindFramebuffer(gl.FRAMEBUFFER,null)}}var framecount=0;function Filter(e,t,r,a,i){var o=new Sprite(lathe([5,0],4,0,1),ZERO,null,!1),[n,l]=createProgram(gl,fragmentShaderHeader+`//SHADER\nvec4 get_tex(int i, vec2 xy_pos) {\n  return get_shader(i, (world_position.xy*.5+.5) + xy_pos/vec2(${0|t}.,${0|r}.));\n}\n\nvec4 get_tex() {\n  return get_tex(0, vec2(0));\n}\n\nvoid main(void) {\n${e}\n}`);[this._texture,this.framebuffer]=setup_framebuffer(31,a==gl.RG,t,r),this.post_filter=(e,a)=>(gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffer),gl.useProgram(n),gl.uniform4fv(l.u_shift_color,global_screen_color),[[e,"u_texture[0]",30],[a,"u_texture[1]",29]].map((e=>{e[0]&&(gl.activeTexture(gl.TEXTURE0+e[2]),gl.bindTexture(gl.TEXTURE_2D,e[0]),gl.uniform1i(l[e[1]],e[2]))})),gl.uniform4fv(l.u_world_position,[0,0,0,0]),gl.uniformMatrix4fv(l.u_world_rotation,!1,IDENTITY),gl.uniformMatrix4fv(l["u_light_matrix[4]"],!1,IDENTITY),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.viewport(0,0,t,r),locations=l,o.render(),this._texture)}var gaussian_2d="//SHADER\nvec4 the_res;\nfor (float i = -6.; i < 7.; i++) {\nfor (float j = -6.; j < 7.; j++) {\n  the_res += exp(-i*i/9.-j*j/9.)*get_tex(0,vec2(j,i));\n}\n}\nout_color = the_res/28.17;";function DrawToScreen$(){var e=gl.canvas.width,t=gl.canvas.height,r=[new Filter("//SHADER\nout_color = dot(get_tex(), vec4(21, 72, 7,0)) > 100. ? get_tex() : vec4(0,0,0,1);\n",e,t,gl.RGBA),new Filter("out_color = get_tex();",e/4,t/4,gl.RGBA),new Filter(gaussian_2d,e/4,t/4,gl.RGBA),new Filter("out_color = get_tex();",e,t),new Filter("out_color = vec4(u_shift_color.rgb + u_shift_color.w*(get_tex(1,vec2(0)) + get_tex()).rgb, 1.);",e,t,gl.RGBA),new Filter("out_color = get_tex();",e,t,gl.RGBA)];return r[5].framebuffer=null,GRAPHICS>3?(camera.framebuffer=null,range):e=>r.reduce(((t,r)=>r.post_filter(t,e)),e)}function make_gl_texture(e,t,r,a,i){var o=gl.createTexture();return gl.activeTexture(gl.TEXTURE0+e),gl.bindTexture(gl.TEXTURE_2D,o),gl.texImage2D(gl.TEXTURE_2D,0,t?gl.RG32F:gl.RGBA32F,r,a,0,t?gl.RG:gl.RGBA,gl.FLOAT,i),o}function setup_framebuffer(e,t,r,a){var i=make_gl_texture(e,t,r,a);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);var o=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,o),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,i,0);var n=gl.createRenderbuffer();return gl.bindRenderbuffer(gl.RENDERBUFFER,n),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,r,a),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,n),[i,o]}var light_id=0;class Light{constructor(e,t,r,a){var i=1024>>GRAPHICS;this.position=e,this.shadow_camera=new Camera(e,[i,i],light_id?2.5:1,!0,this.id=light_id++,t,r),this.shadow=a,this._texture=this.shadow_camera._texture,this.brightness=2,this.filter=new Filter(gaussian_2d,i/2,i/2,gl.RG)}compute_shadowmap(){this.shadow_camera.position=this.position,gl.useProgram(program2),locations=locations2,gl.activeTexture(gl.TEXTURE0+this.id),gl.bindTexture(gl.TEXTURE_2D,this._texture),gl.uniform1i(locations.u_which_shadow_light,this.id),this.shadow_camera.draw_scene(),gl.bindFramebuffer(gl.FRAMEBUFFER,null),this.filter.post_filter(this._texture)}}var all_textures=[];function make_texture(e){all_textures.push(make_gl_texture(10,0,256,256,new Float32Array(e))),gl.generateMipmap(gl.TEXTURE_2D),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR)}function setup_graphics(){gl.getExtension("EXT_color_buffer_float"),gl.getExtension("OES_texture_float_linear"),[program1,locations1]=createProgram(gl,fragmentShaderHeader+program1Shader),[program2,locations2]=createProgram(gl,fragmentShaderHeader+"//SHADER\n\nvoid main() {\n    out_color.r = distance(u_light_position[u_which_shadow_light], world_position);\n    out_color.g = out_color.r*out_color.r;\n}\n");var e=(e,t,r)=>e*(1-(r=r*r*(3-2*r)))+t*r,t=range(16).map((e=>range(16).map((e=>NewVector(urandom(),urandom(),0)._normalize())))),r=cartesian_product_map(range(256),range(256),((r,a)=>{r/=16,a/=16;var i=NewVector(0|a,0|r,0),o=cartesian_product_map(range(2),range(2),((e,o)=>t[r+e&15][a+o&15].dot(i.add(NewVector(o-a,e-r,0)))));return 2*(o=e(e(o[0],o[1],a-i.x),e(o[2],o[3],a-i.x),r-i.y))+.2}));make_texture(r.map((e=>[e,e,e,1])).flat()),make_texture(r.map((e=>[e,0,0,1])).flat()),make_texture(cartesian_product_map(range(256),range(256),((e,t)=>{if(e%64<=2||Math.abs(t-(e/64|0)%2*128)<=2)return[0,0,0,1];var a=.9-r[256*t+e]/20;return[a,a,a,1]})).flat());var a=cartesian_product_map(range(16),range(8),((e,t)=>[32*e,64*(t+e%2/2),1+e%2]));make_texture(cartesian_product_map(range(256),range(256),((e,t)=>{var r=a.map((r=>[r[2]*(Math.abs(r[0]-t)+Math.abs(r[1]-e)),r[2]])).sort(((e,t)=>e[0]-t[0]));return Math.abs(r[0][0]-r[1][0])<4?[1,1,1,1]:[.1,.1,.1,1]})).flat()),make_texture(r.map((e=>[e,0,0,1])).flat())}
  </script>
<script>
    class HitBox{constructor(t,e,i,s,o){t instanceof Vector&&(this.dead=!0,this.position=ZERO,t=this,e=0,i=0,s=0),this.parent_obj=t,this.solid=!0,this.position=t.position,this.theta=e,this._width=i,this._height=s,this.parallel_dir=NewVector(-Math.sin(this.theta)*this._width,Math.cos(this.theta)*this._width,0),this.offset=o||0}update(){this.position=this.parent_obj.position.add(Z_DIR.scalar_multiply(this.offset)),this.dead=this.parent_obj.dead}render(){}onhit(t){return this.parent_obj.onhit(t)}}class Wall extends HitBox{constructor(t,e,i,s){s<0&&(s=-s,t.z-=s),super({position:t,onhit:t=>{}},e,i,s)}}class LockedDoor extends Wall{constructor(t,e){super(t,e,32,30),this.uid=e,this.sprite=e==Math.PI/2?new Sprite(makecube(NewVector(1,64,40)),this.position,matrix_rotate_xy(e),null,[1,1,1],[21,2]):merge_sprites(range(20).map((i=>new Sprite(make_cylinder(NewVector(1,1,40)),t.add(mat_vector_product(matrix_rotate_xy(e),NewVector(0,4*i-40,0))),matrix_rotate_xz(Math.PI/2),1,pallet[8*e/Math.PI]))))}render(){this.sprite.render()}}class PhysicsObject{constructor(t,e,i,s){this.sprite=t,this.position=e,this.velocity=i,this.ghost=s,this.still=void 0,this.dead=void 0,this.dz=.003,this.slow=.999,this.floor_cache={}}update(t){if(this.still)return!0;this.velocity.z-=this.dz*t,this.velocity=this.velocity.scalar_multiply(this.slow**t),this.position=this.position.add(this.velocity.scalar_multiply(t/16));var e=map.get_floor_height(this.position,this.floor_cache)+.5;this.ghost?this.position.z<e&&(this.die&&this.die(),this.dead=!0):(this.position.z<e&&(this.still=this.velocity.vector_length()<.1,this.position.z=e,this.velocity.z=-this.velocity.z,this.velocity=this.velocity.scalar_multiply(.8)),detect_collision_positions(this.position,this.position.add(this.velocity.scalar_multiply(2))).map((t=>{this.onhit&&this.onhit(t[1]),t[1].onhit&&t[1].onhit(this);var e=t[0].subtract(this.position);this.velocity.y*=Math.abs(e.y)>.1?-1:1,this.velocity.x*=Math.abs(e.x)>.1?-1:1,this.position=this.position.lerp(t[0],1.3)})))}render(){this.sprite.position=this.position,this.sprite.render()}}class BodyPart extends PhysicsObject{constructor(t,e,i){super(t,e,i),this.spins=urandom_vector()}update(t){if(!super.update(t)){var e=t*this.velocity.vector_length()*.005;this.sprite.rotation=multiply(this.sprite.rotation,[matrix_rotate_xy(this.spins.x*e),matrix_rotate_yz(this.spins.y*e),matrix_rotate_xz(this.spins.z*e)].reduce(multiply))}}}class EnemyBullet extends PhysicsObject{constructor(t,e){t=t.add(e),super(new Sprite(enemy_bullet,t,matrix_rotate_xy(Math.atan2(e.y,e.x)),1,[5,0,0],[22,1]),t,e),this.dz=0,this.slow=1,this.start=last_now}update(t){super.update(t),this.position.distance_to(camera.position)<5&&(user_hit(this.position),this.dead=!0),this.dead|=last_now-this.start>1e4}onhit(){range(30).map((t=>objects.push(new Hit(this.position,2)))),this.dead=!0}}var killed_enemies=0;class BaseEnemy{constructor(t,e,i,s){this.position=t.add(Z_DIR.scalar_multiply(5)),this.theta=e||0,this.floor_cache={},this.state=0,this.timer=0,this._height=i,objects.push(new HitBox(this,0,s,2*s,-i)),objects.push(new HitBox(this,Math.PI/2,s,2*s,-i)),this.patrol=void 0,this.waypoint=t,this.attacking=0,this.time=100*urandom(),this.spin_rate=.1,this.speedinv=50,this.grounded=0,this.dead=void 0}gethelp(){objects.map((t=>{t instanceof BaseEnemy&&t.position.distance_to(this.position)<100&&!detect_collision_positions(t.position,this.position,!1,!0).length&&(t.attacking=t.state=1)}))}onhit(t){t||(this.dead=!0,killed_enemies++%(5+2*DIFFICULTY)==0&&objects.push(new Health(this.position.noz().add(Z_DIR.scalar_multiply(map.get_floor_height(this.position,this.floor_cache))))),range(30).map((t=>objects.push(new Hit(this.position,4)))),this.gethelp(),play(sounds.boom),this.components.map((t=>{objects.push(new BodyPart(t,this.position.add(t.position),mat_vector_product(matrix_rotate_xy(-camera.theta),NewVector(urandom(),3+urandom(),1+Math.random()))))})))}update(t){this.patrol=this.patrol||[detect_collision_positions(this.position,this.position.add(mat_vector_product(matrix_rotate_xy(this.theta),NewVector(1e5,0,0))),0,1)[0][0].subtract(mat_vector_product(matrix_rotate_xy(this.theta),NewVector(5,0,0))),this.position];var e=-angle_between(this.position,camera.position);if(Math.random()<1/t&&!this.attacking&&(Math.abs(e-this.theta-Math.PI/2)<Math.PI/3||Math.abs(e-this.theta-Math.PI/2)>2*Math.PI-Math.PI/3)&&!detect_collision_positions(camera.position,this.position,!1,!0).length&&(this.gethelp(),this.attacking=this.state=1),0==this.state){var i=this.position.add(NewVector(Math.cos(this.theta)*t/this.speedinv,Math.sin(this.theta)*t/this.speedinv,0)),s=map.get_floor_height(i,this.floor_cache),o=camera.position.subtract(this.position).vector_length()<10&&i.distance_to(camera.position)<this.position.distance_to(camera.position);if(o&&user_hit(this.position),detect_collision_positions(this.position,this.waypoint,!1,!0).length>0||o||Math.abs(s-this.position.z+this._height)>5+this.grounded)return this.waypoint=this.position.add(urandom_vector().scalar_multiply(20).noz()),this.theta=Math.PI*urandom(),void(this.state+=Math.random()<.1);for(var a=this.waypoint.subtract(this.position).noz(),r=Math.atan2(a.y,a.x);r-this.theta>Math.PI;)this.theta+=2*Math.PI;for(;this.theta-r>Math.PI;)this.theta-=2*Math.PI;this.theta+=(r-this.theta)*this.spin_rate,this.position=i,this.position.z=s*(this.grounded<10)+this._height,a.vector_length()<30/this.spin_rate/this.speedinv&&(this.attacking?this.state=1:this.patrol.unshift(this.waypoint=this.patrol.pop()))}if(1==this.state){a=camera.position.subtract(this.position)._normalize();this.waypoint=this.position.add(a.scalar_multiply(10)),Math.random()<.1&&!this.grounded?objects.push(new EnemyBullet(this.position.add(Z_DIR.scalar_multiply(5)),camera.position.subtract(this.position.add(Z_DIR.scalar_multiply(8)))._normalize().scalar_multiply(2+DIFFICULTY))):this.state=0}}render(t,e,i,s){this.sprites.map(((i,o)=>i.rotation=multiply(matrix_rotate_xy(this.theta+Math.PI/2),s(Math.sin(t[o]*this.time)/e[o])))),this.sprites.map(((t,e)=>t.position=this.position.add(Z_DIR.scalar_multiply(Math.cos(2*this.time)/3+5*(e>i))))),this.sprites.map((t=>t.render()))}}class Enemy extends BaseEnemy{constructor(t,e){super(t,e,5,6),this.components=[[[2,3,5],[1.5,0,-5]],[[2,3,5],[-1.5,0,-5]],[[1.5,2,5],[-3.25,0,-5]],[[1.5,2,5],[3.25,0,-5]],[[5,2,5],[0,-.5,0],[.8,.8,.8]],[[4,5,4],[0,0,5],[.8,0,0]],[[.5,1.25,.5],[1,-2,7],[5,0,0]],[[.5,1.25,.5],[-1,-2,7],[5,0,0]],[[5,1,5],[0,1,0],[.4,.4,.4]]].map((t=>new Sprite(makecube(NewVectorFromList(t[0])),NewVectorFromList(t[1]),null,!1,t[2]))),this.sprites=[merge_sprites(this.components.slice(4)),...this.components.slice(0,4).map((t=>merge_sprites([t])))]}update(t){super.update(t),this.time<100&&DIFFICULTY&&(this.time+=100,objects.push(new FlyingEnemy(this.position,this.theta))),this.time+=t/160}render(){super.render([0,1,-1,1,-1],[1,1,1,2,2],2,matrix_rotate_yz)}}class FlyingEnemy extends BaseEnemy{constructor(t,e){super(t.copy(),e,8,6),this.components=this.sprites=[new Sprite(makecube_fn((t=>t.vector_multiply(NewVector(3,3*(.7-t.x),.1)).subtract(X_DIR.scalar_multiply(1.5)))),ZERO,0,0,[.3,.3,.3]),new Sprite(makecube_fn((t=>mat_vector_product(matrix_rotate_xy(Math.PI),t.vector_multiply(NewVector(3,3*(.7-t.x),.1)).subtract(X_DIR.scalar_multiply(1.5))))),ZERO,0,0,[.3,.3,.3]),new Sprite(makecube(NewVector(.8,3,.4)),ZERO,0,0,[.3,.3,.3]),new Sprite(makecube_fn((t=>t.vector_multiply(NewVector(.2,3.3,.2)).add(NewVector(0,0,.1)))),ZERO,0,1,[8,0,0])],this.height_offset=5*urandom(),this.spin_rate=.1,this.speedinv=20,this.grounded=50}update(t){super.update(t),this.floor_cache.o&&(this._height+=.1*((this.floor_cache.o.floor_height+this.floor_cache.o.ceil_height)/2+this.height_offset-this._height));var e=2*Math.sin(this.time/5)+Math.sin(this.time);this.time+=t*(2+Math.sin(this.time))/200;var i=2*Math.sin(this.time/5)+Math.sin(this.time);this.position.z+=i-e;var s=1-1.01**-camera.position.subtract(this.position).noz().length_squared();this.position.z=this.position.z*s+(camera.position.z-10)*(1-s)}render(){super.render([1,-1,0,0],[1,1,1,1],9,matrix_rotate_xz)}}function detect_collision_positions(t,e,i,s){var o=e.subtract(t).noz(),a=o.vector_length();return objects.map((r=>{if(r.solid&&(!s||r instanceof Wall)&&!(a+2*r._width<((r.position.x-t.x)**2+(r.position.y-t.y)**2)**.5)){var h=ray_line_intersect(t,o,r.position.add(r.parallel_dir),r.position.subtract(r.parallel_dir));return h&&h[0]<=1&&r.position.z<t.lerp(e,h[0]).z&&t.lerp(e,h[0]).z<r.position.z+r._height&&(!i||!(r instanceof LockedDoor)||r.uid==Math.PI/2||h[1]%.05<.02)?[t.lerp(e,h[0]),r]:void 0}})).concat(map.regions.map((s=>{var o;if(i)return e.z<s.ceil_height&&(o=t.lerp(e,(s.floor_height-t.z)/(e.z-t.z))),s.ceil_height<e.z&&(o=t.lerp(e,(s.ceil_height-t.z)/(e.z-t.z))),o&&map.get_region_at(o)==s?[o,{}]:void 0}))).filter((t=>t)).sort(((e,i)=>e[0].distance_to(t)-i[0].distance_to(t)))}class Flash{constructor(t,e,i){this.sprite=new Sprite(sphere(5),t.add(NewVector(0,0,-1.5)).add(e.scalar_multiply(2)),0,1,[10,10,10]),this.dead=void 0,this.c=0}render(){this.sprite.render(),this.dead=this.c++>2}}class LightFlash{constructor(t,e){this.dead=void 0,this.c=e,lights[3].position=t.copy()}render(){this.c--||(lights[3].position.z=1e9,this.dead=!0)}}var hit_sprite_pool=[];class Hit extends PhysicsObject{constructor(t,e){var i=.8*Math.random();super(hit_sprite_pool.pop()||new Sprite(explosion,t.add(urandom_vector().scalar_multiply(e)),0,1,[10*Math.cos(i),10*Math.sin(i),0]),t,new Vector(urandom()/2,urandom()/2,1.5+urandom()),!0),this.dz=.01}die(){this.sprite.position.z=1e5,hit_sprite_pool.push(this.sprite)}}class Shell extends BodyPart{constructor(t,e){super(new Sprite(shell,t,multiply(chaingun.rotation,matrix_rotate_xz(Math.PI/2)),0,[.4,.4,.4]),t,NewVector(urandom(),urandom(),3.5+urandom()/2).subtract(e).scalar_multiply(.2))}}class Collectable{constructor(t,e){this.sprite=e,this.sprite.position=(this.position=t.add(Z_DIR.scalar_multiply(2))).copy(),this.dead=void 0,this.time=0,this.collect_dist=10}collect(){play(sounds.collect),setTimeout((()=>play(sounds.collect2)),150)}update(t){this.position.noz().distance_to(camera.position.noz())<this.collect_dist*(1+going_back/2)&&(this.collect(),this.dead=!0)}render(){this.sprite.render()}}class Health extends Collectable{constructor(t){var e=lathe([.5,-.5,.6,.5,.3,.5,.3,.8,0,.5,-.2,.3,-.3,.3,-.4,.3,-.3,.3,-.1,.3,0,.5,-.2,.8],16,0,!0);super(t,new Sprite(e,null,IDENTITY,!1,[.1,.1,1]))}collect(){super.collect(),update_health(1),fade_to([0,0,1,.5])}}class Flashlight extends Collectable{constructor(t,e){t=t.add(NewVector(4,0,0));var i=lathe([.9,0,.1,.1,0,4,.5,1,0,1,-.1,0,-.4,-1],32,0,!0),s=multiply(matrix_rotate_xy(-e),matrix_rotate_yz(-1.4));super(t,[new Sprite(i,null,s,!1,[.4,.4,.4]),new Sprite(sphere(2),null,0,1,[5,5,5])]),this.collect_dist=15,this.sprite[1].position=(this.sprite[0].position=this.position).add(mat_vector_product(s,Z_DIR.scalar_multiply(5.8))),lights[0].position=t.add(mat_vector_product(s,Z_DIR.scalar_multiply(8))),lights[0].shadow_camera.theta=e}collect(){super.collect(),fade_to([.4,.4,.4,1]),light_is_held=!0}render(){this.sprite.map((t=>t.render()))}}var pallet=[[.47,.74,.6],[.12,.4,.6],[.95,.85,.35],[.95,.33,.22],[0,1,0]];class Goal extends Collectable{constructor(t,e){var i=pallet[8*e/Math.PI],s=e==Math.PI/2?new Sprite(lathe([0,0,2,2,0,.1,-1,.6],8,0,!0),t,IDENTITY,!0,i):s=merge_sprites([new Sprite(lathe([1.3,0,.8,0,0,.8,-.8,0,0,-.8],16,0,!1),NewVector(-3,0,0),matrix_rotate_yz(Math.PI/2),!0,i),new Sprite(make_cylinder(NewVector(.6,.6,9)),NewVector(-1,0,0),null,!1,i),new Sprite(makecube(NewVector(2,1,1.5)),NewVector(6,0,-1.5),null,!1,i),new Sprite(makecube(NewVector(.6,1,.5)),NewVector(5.25,0,-2),null,!1,i),new Sprite(makecube(NewVector(.6,1,.5)),NewVector(6.75,0,-2),null,!1,i)]);s.rotation=matrix_rotate_xy(e),t.z+=6*(1==map.levels.length&&!i[4]),super(t,s),this.collect_dist=15,this.uid=e}update(t){super.update(t),this.sprite.rotation=multiply(matrix_rotate_xy(t/400),this.sprite.rotation),this.sprite.position.z=this.position.z+4*Math.sin(this.time+=t/300)+4}collect(){var t=objects.filter((t=>t instanceof LockedDoor&&this.uid==t.uid));t[0].parent_obj.dead=!0,this.uid==Math.PI/2?(play(sounds.clock),fade_to([1,1,1,1]),objects.push(new RealDoor(t[0].position.subtract(NewVector(0,40,-10)))),map.put_objects(map.remake.filter((t=>BaseEnemy.isPrototypeOf(t[1])||t[1]==ManyEnemies)),objects),objects.map((t=>t.attacking=1)),going_back=!0,music_timeouts.map(clearTimeout),music_timeouts=[]):(super.collect(),fade_to([0,.5,0,.5]))}}class RealDoor extends Collectable{constructor(t){super(t.subtract(Z_DIR.scalar_multiply(20)),new Sprite(makecube(NewVector(1,40,40)),t,matrix_rotate_xy(Math.PI/2),1,[10,10,10])),lights[2].position=t.add(NewVector(0,-20,0)),lights[2].shadow_camera.theta=0,lights[2].shadow=!0,this.count=0}update(t){if(super.update(t),(this.count+=t)>200&&!this.w){this.w=1;var e=objects;objects=objects.filter((t=>t.q)),lights[2].compute_shadowmap(),objects=e}}collect(){fade_to([1,1,1,1]),map.levels.length>1?(keys={},setTimeout((t=>{set_resolution(-1),reset(),map.levels.shift(),map.load_level()}),200)):(hQ.style.display="none",qQ.style.top="40vh",setTimeout((t=>{end_screen=!0,document.exitPointerLock(),global_screen_color=[1,1,1,0],cancelAnimationFrame(frame),hE.innerHTML=`You got back in ${last_now/6e4|0}m ${last_now/1e3%60|0}s.<br><br>`,DIFFICULTY?(setTimeout((t=>hE.innerHTML+="Congratulations.<br><br>Developer Par: 9m 00s<br><br>Reload to play again."),2e3),DIFFICULTY=1):(setTimeout((t=>hE.innerHTML+="Get ready for hard difficulty."),2e3),DIFFICULTY=1,setTimeout((t=>{global_screen_color=[0,0,0,1],end_screen=!1,health=5,reset(),map.levels=[...map.all_levels],map.load_level(),requestAnimationFrame(game_step)}),5e3))}),200))}}var last_user_hit=0;function update_health(t){hW.style.width=(health=Math.min(health+t,9))+1+"vw",hW.className="b"[health>2|0]}function user_hit(t){last_now-last_user_hit>450-200*DIFFICULTY&&(play(sounds.hit),last_user_hit=last_now,objects.push(new LightFlash(t)),range(15).map((e=>objects.push(new Hit(t,4)))),camera_shake++,fade_to([.3,0,0,.7]),update_health(-1))}var last_fades=[];function fade_to(t){global_screen_color=t.map((t=>t)),last_fades.map(clearTimeout),last_fades=range(20).map((e=>{return i=e/20,setTimeout((e=>global_screen_color=[t[0]*i,t[1]*i,t[2]*i,t[3]*i+(1-i)]),400*(1-i)+200);var i}))}function ManyEnemies(t,e){return range(5*DIFFICULTY+5+e*Math.PI|0).map((e=>objects.push(new[Enemy,FlyingEnemy][e%2](t.add(urandom_vector().noz().scalar_multiply(20)),10*urandom())))),{render:range,dead:1}}var explosion,sphere,shell,enemy_bullet,my_body,make_cylinder=t=>lathe([1,0,0,.001,0,1,0,.001],32,0,!0,(e=>mat_vector_product(matrix_rotate_xz(-Math.PI/2),e.vector_multiply(t)))),makecube_fn=t=>lathe([.71,0,0,1],4,0,!0,(e=>t(mat_vector_product(matrix_rotate_xy(-Math.PI/4),e)))),makecube=t=>makecube_fn((e=>e.vector_multiply(t))),all_objects=[null,null,Enemy,FlyingEnemy,Health,Goal,LockedDoor,Flashlight,null,ManyEnemies];function setup_game(){explosion=(sphere=t=>lathe([0,-.5,.35,.15,.15,.35,-.15,.35,-.35,.15].map((e=>e*t)),8,0,!1))(1),shell=lathe([.5,0,0,.05,-.1,0,0,.01,0,1.5,0,.01,-.05,0,0,-1.4],8,0,!0),enemy_bullet=lathe([.2,0,.2,2,.4,1,.4,.4,0,.6,-.4,.4,-.4,.2],32,0,!0,(t=>mat_vector_product(matrix_rotate_xz(-Math.PI/2),t))),[2,5,6].map((t=>chaingun.push(new Sprite(make_cylinder(NewVector(1.8,1.8,.5)),NewVector(t,0,0),null,!1,[.7,.7,.7])))),range(8).map((t=>{chaingun.push(new Sprite(make_cylinder(NewVector(.5,.5,8.5)),mat_vector_product(matrix_rotate_yz(t*Math.PI/4),Y_DIR),null,!1))})),chaingun=merge_sprites(chaingun),chaingun.recoil=ZERO}
    </script>
<script>
      class Map{constructor(){this.levels=["rgt413aHp9UFRwdXm2S6cGajdGc0csIDhMeKwQUngnOne8qtCa19bVwnkHBQZ2LYdcSzFERiVTdZmLd7N3NWfFtGTMrYttSyYil4xasKMDBwscKcTWx9vGJ5cMQDUslqsQiEm3iHe2d4RwnLt8RGZ3YXeGfCjgNz13uQB3OHdqd+RnbPkq0DeDd2ZZ10246xA7d7Nw==","ISyRA4qoQGbRdGKrcGV7co0JrseGo4VBdwd3rAOEx4rBBSeCg4eLzAVL26uTRWYjcmQ2cGR6cMGMsgmu445716NQFAfEkQNKKJNiO37CCKSqvG45FHKzwqoC2ihlhnRpknDIjbQIGyc2Y7LEjIzEkQVUVVyquGdDdMONA7CMS2PScJEEo4mXPMEEV6PjTAWMjJNzYMcES2Vikw==","IcCVBWJhZ21sZqd0ZTRxZzpykbMVemdseVdemunnhCVUpppIyYWBcTYzZNxwzK4DB3nnYlF0Ytd8Yt1wkQMHeedmbXFjnnCRAwd555EDB3nnkbQIiIe16RsYJUPEkQcFYZJ2o56NYyV0wgM1bZdldXRkRHDBgIuqA4FHbcGnA6ehF2KJcGKWcJGwBWJAxa6ewpAEKRJT52J9cMGRsQWbKnw2cGK2cMGRA7iOJpG1BzyNq5B1l4LBlgNXeZdjfXBiKHBkTXAh7iGHA6ZUSA==","Ia2OA7S3KmIKcAMsxsBk23DCjQPCRxtm63JlbXJifXCRBdO0KCpJjQdzoZS7uigqwpEFt1RDB7tmc3TBkKwDhMeKjLIGyLleC8BUwpGqECira1tLGorks6q6pEYThIDEkA1K59bJdCUYZkGzRyrOYppwwrQFMcHZfTtpUXDCAlU3ZalxZLpwy7EGoOXcPgklwZED5ZkKwQShkkk+aUJ1wQOlEklkenDCkasF2p44UzVmpXFlx3Bm6HPCA7aKJ2WWdNuLsQatKwcywOZnWXVmp3BpPnDCmAO8OjRip3BipXBl1HPThqwFJ4KDh4vQrQdsm6eVVlaD","IQQhZ5MCkqlmfXFlWnJm2HRnV3JkPHCLqwWZbFojhMKzC325p6aUclB3B3dsYo5wwawDhMeKwQUngoOHi8yasQNamIRlenRiVnhirHBiqHBjm3CMsAVqjOdgNmLbcGXtcQ64tMyOXhwbqdPhgHBABM2SrQOOh2CMsQTZfThlwQVLN5zTocK0CgcoNidxx6WnqchiSXjCqgNHdadjZnxiLXBjTXCNA0d1p40DR3WnjQNHdafPlQYbToy3YcNmHnLCBDeb5XO0CHvL6eWQRSQXaepw"],this.all_levels=[...this.levels]}put_objects(e,t){e.map((([e,s,i,h,o,l])=>{(t||e).push(new s(i.add(NewVector(0,0,this.get_floor_height(i.add(NewVector(2,2,0))))),h,o,l))}))}load_level(){var e=this.levels[0];turtledisplay||(turtledisplay=new TurtleDisplay(this,uncompress(e))),light_id=0,objects=[],lights=range(4).map((e=>new Light(NewVector(0,0,1e3),0,0))),lights[0].shadow=lights[0].dynamic_shadow=!0;[this.regions,this.remake]=run_turtle(uncompress(this.levels[0]),[]),map.put_objects(this.remake);var t,s=range(32).map((e=>[[],[]])),i={},h=(e,i)=>{s[e][0].push(range(6*(i.length-2)).map((e=>[t,0,0]))),s[e][1].push(i,[...i].reverse())};this.regions.map((e=>{e.lines.map((t=>{t=t.map((e=>[e.x,e.y])).sort(),i[t]=push(i[t]||[],[e.floor_height,e.ceil_height])})),h(e.floor_height<0?20:22,e.vertices.map((t=>NewVector(t.x,t.y,e.floor_height)))),h(21,e.vertices.map((t=>NewVector(t.x,t.y,e.ceil_height))))})),Object.keys(i).map((e=>{var[s,o,l,c]=e.split(",").map(Number);transpose(i[e]).map((e=>{var i=[NewVector(s,o,e[0]),NewVector(l,c,e[0]),NewVector(l,c,e[1]||0),NewVector(s,o,e[1]||0)],r=i[0].lerp(i[1],.5);t=-angle_between(i[0],r),objects.push(new Wall(r,t,i[0].distance_to(r),i[2].z-i[0].z)),h(21,i)}))})),s.map((([e,t],s)=>{e.length&&(objects.unshift(new Sprite(make_output_from_faces(t),ZERO,null,null,[1,1,1],[s,(21==s)+1])),objects[0].q=!0,objects[0].aq_angle=new Float32Array(e.flat(2)),objects[0].rebuffer())})),objects.push(chaingun),objects.push(my_body=merge_sprites(new Enemy(NewVector(-1e6,0,0)).sprites.map(((e,t)=>(e.position=e.position.add(Z_DIR.scalar_multiply(5*(3==t||4==t))),e))))),lights.map((e=>e.shadow&&e.compute_shadowmap())),music_timeouts.map(clearTimeout),music_timeouts=[],doplay()}get_floor_height(e,t){return(t=t||{}).o&&this.is_in_region(t.o,e)?t.o.floor_height:(t.o=this.get_region_at(e),t.o?t.o.floor_height:-100)}is_in_region(e,t){return t=t.add(urandom_vector().scalar_multiply(.01)),e.lines.filter((e=>ray_line_intersect(t,X_DIR,...e))).length%2==1}get_region_at(e){for(var t in this.regions)if(this.is_in_region(this.regions[t],e))return this.regions[t]}}class MapPolygon{constructor(e,t,s){this.vertices=e,this.floor_height=t,this.ceil_height=s,this.lines=pairs([...e,e[0]],((e,t)=>[e,t])).sort()}}function run_turtle(e){}function run_turtle(e,t){for(var s=[],i=[ZERO],h=4,o=40,l=[],c=0;c<e.length;){var r=e[c++],[a,d]=[31&r,r>>5];if(d<=1&&(s.push(new MapPolygon([i[0],...range(a).map((t=>(i.unshift(i[0].add(NewVector(8*((e[c]>>4)-7),8*(e[c++]%16-7),0))),i[0])))],h,o)),1==d&&s.pop()),3==d){l.push([objects,all_objects[a],i[0].add(NewVector(8*((e[c]>>4)-7),8*(e[c++]%16-7),2*((e[c]>>4)-7))),e[c++]%16/8*Math.PI,0,!0]);var n=l[l.length-1];(t||[]).push({class_idx:a,position:n[2].copy(),theta:n[3]}),!a&&t&&t[0]&&(t[0].theta2=n[4])}h+=2*(a-15)*(4==d),o+=4*(a-15)*(5==d),i.splice(0,a*(6==d))}return[s,l]}class TurtleDisplay{constructor(e,t){this.map=e,this.code=t,this.objects=[],this.regions=run_turtle(t,this.objects)[0],console.log("Turtle objects",this.objects);var s=document.createElement("div");s.style="position: absolute; left: 850px; top: 20px",(i=document.createElement("input")).type="button",i.value="+",i.onclick=()=>{this.zoom/=2,this.x=this.x+100/this.zoom,this.y=this.y+100/this.zoom,this.render()},s.appendChild(i),(i=document.createElement("input")).type="button",i.value="-",i.onclick=()=>{this.zoom*=2,this.x=this.x-200/this.zoom,this.y=this.y-200/this.zoom,this.render()},s.appendChild(i),(i=document.createElement("span")).innerHTML="&nbsp;&nbsp;pos:",s.appendChild(i),this.mapx=i=document.createElement("input"),i.value="",i.style="width: 4em",i.id="mapx",s.appendChild(i),this.mapy=i=document.createElement("input"),i.value="",i.style="width: 4em",i.id="mapy",s.appendChild(i),this.mapx.onchange=this.mapy.onchange=e=>{this.regions.map((t=>{t.vertices.map((t=>{t.distance_to(this.selectedv)<1&&(e.target==this.mapx?t.x=0|this.mapx.value:t.y=0|this.mapy.value)}))})),this.updatemap(),this.get(),this.setcode(),this.render()},(i=document.createElement("span")).innerHTML="&nbsp;&nbsp;height:",s.appendChild(i),this.mapf=i=document.createElement("input"),i.value="",i.style="width: 3em",i.id="mapf",s.appendChild(i),this.mapf.onchange=e=>{this.selectedr?(this.selectedr.floor_height=0|this.mapf.value,this.updatemap(),this.get(),this.setcode(),this.render()):this.selectedo&&(this.selectedo.zoff=0|this.mapf.value)},this.mapc=i=document.createElement("input"),i.value="",i.style="width: 3em",i.id="mapc",s.appendChild(i),this.mapc.onchange=e=>{this.selectedr.ceil_height=0|this.mapc.value,this.updatemap(),this.get(),this.setcode(),this.render()},(i=document.createElement("span")).innerHTML="<br>light:",s.appendChild(i),this.lightf=i=document.createElement("input"),i.value="",i.style="width: 3em",s.appendChild(i),this.lightf.onchange=e=>{this.selectedr.floor_light=(0|this.lightf.value)/15,this.updatemap(),this.get(),this.setcode(),this.render()},this.lightc=i=document.createElement("input"),i.value="",i.style="width: 3em",s.appendChild(i),this.lightc.onchange=e=>{this.selectedr.ceil_light=(0|this.lightc.value)/15,this.updatemap(),this.get(),this.setcode(),this.render()},(i=document.createElement("span")).innerHTML="loopid:",s.appendChild(i),this.loopid=i=document.createElement("input"),i.value="",i.style="width: 3em",s.appendChild(i),this.loopid.onchange=e=>{this.selectedr.loopid=0|this.loopid.value,this.updatemap(),this.get(),this.setcode(),this.render()},(i=document.createElement("input")).type="button",i.value="Begin",i.onclick=()=>{this.get(),reset(),this.updatemap()},s.appendChild(i),(i=document.createElement("input")).type="button",i.value="Get",i.onclick=()=>{var e=range(100).map((e=>this.get(!0)));console.log("Lengths",e.map((e=>e.length)).sort(((e,t)=>e-t)));var t=e.map((e=>[e.length,e])).sort(((e,t)=>e[0]-t[0]))[0][1];console.log(t.length,btoa(t.map((e=>String.fromCharCode(e))).join(""))),this.lightf.value=btoa(t.map((e=>String.fromCharCode(e))).join(""))},this.get=e=>{var t=[NewVector(0,0,0)],s=4,i=40,h=[],o=Math.random(),l=this.regions.map((e=>{var t=0;return e.vertices.map(((s,i)=>{(s.x<e.vertices[t].x||s.x==e.vertices[t].x&&s.y>e.vertices[t].y)&&(t=i)})),e.vertices=[...e.vertices.slice(t),...e.vertices.slice(0,t)],e.vertices[0].y==e.vertices[1].y&&(e.vertices.reverse(),e.vertices.unshift(e.vertices.pop())),e})),c=l.map((e=>{var t=e.vertices[0];return e.vertices.slice(1).map((e=>{var s=e.subtract(t);return t=e,s.id()})).join(";")})),r=[];c.map(((e,t)=>{var s=!1;r.map(((i,h)=>{c[i[0]]==e&&(s=!0,i.push(t))})),s||r.push([t])}));var a=[];r.map((e=>{if(e.length>=3){var t=(e=e.sort(((e,t)=>l[t].vertices[0].x+l[t].vertices[0].y/1e3-(l[e].vertices[0].x+l[e].vertices[0].y/1e3)))).map((e=>l[e].vertices[0])),s=pairs(t,((e,t)=>t.subtract(e).id()));new Set(s).size,a.push(...e.slice(1))}}));for(var d=[],n=[l[e?Math.floor(Math.random()*l.length):0]];n.length>0;){var p=n.pop();d.some((e=>e==p))||(d.push(p),p.vertices.map((e=>{n.push(...l.filter((t=>t.vertices.some((t=>t.distance_to(e)<1)))))})))}if(d.length!=l.length&&console.log("BAD"),e){var m=Math.random();m<.5&&(d=d.reverse()),(m=Math.random())<.5&&d.map((e=>{Math.floor(Math.random()*e.vertices.length);e.vertices.reverse()}))}return d.map((e=>{var l,c=e.vertices.map((e=>NewVector(Math.round(e.x/8),Math.round(e.y/8),e.z))),r=1e9;if(c.map(((e,s)=>{t.map(((t,i)=>{t.distance_to(e)<1&&i<r&&(r=i,l=s)}))})),r<=31)r>0&&(t.splice(0,r),h.push(192+r)),c=[...c.slice(l),...c.slice(0,l)];else for(var a=c[0];a.distance_to(t[0])>0;){h.push(33);var d=a.subtract(t[0]);h.push(clamp(d.x,-7,7)+7<<4|clamp(d.y,-7,7)+7),t.unshift(t[0].add(NewVector(clamp(d.x,-7,7),clamp(d.y,-7,7),0)))}for(;Math.abs(s-e.floor_height)>=2;){d=(e.floor_height-s)/2|0;d=Math.max(Math.min(d,15),-15),s+=2*d,h.push(128+(d+15))}for(;Math.abs(i-e.ceil_height)>=4;){d=(e.ceil_height-i)/4|0;d=Math.max(Math.min(d,15),-15),i+=4*d,h.push(160+(d+15))}c[0].distance_to(t[0])>0&&sdf;var n=pairs(c,((e,t)=>t.subtract(e).x<=8&&t.subtract(e).x>=-7&&t.subtract(e).y<=8&&t.subtract(e).y>=-7)).every((e=>e));c.length>31&&sdf,n&&(h.push(c.length-1),c.slice(1).map((s=>{var i=s.subtract(t[0]);(i.x<-7||i.x>8||i.y<-7||i.y>8)&&(console.log("FAILED TO SERIALIZE",e),console.log(i.x,i.y),sdf),h.push(i.x+7<<4|i.y+7),t.unshift(s)}))),this.objects.map((e=>{if(e.did!=o){var i=e.position.subtract(t[0].scalar_multiply(8));if(i.x<-56||i.x>56||i.y<-56||i.y>56);else{e.did=o;var l=Math.round(e.theta%(2*Math.PI)/Math.PI*8)%16;h.push(96+e.class_idx,7+(i.x/8|0)<<4|7+(i.y/8|0),((e.zoff||s)-s)/2+7<<4|0|l)}}}))})),this.code=h,console.log(h.length,btoa(h.map((e=>String.fromCharCode(e))).join(""))),h},s.appendChild(i),s.appendChild(document.createElement("br"));var i=document.createElement("canvas");i.style="border: 1px solid #000",i.height=i.width="400",s.appendChild(i),document.body.appendChild(s),this.ctx=i.getContext("2d"),this.mapdrag=!1,this.vertexdrag=!1,this.x=0,this.y=0,this.zoom=1,this.downtime=0,this.selectedv=void 0,this.selectedr=void 0,this.selectede=void 0,this.selectedo=void 0;var h=(e,t)=>{t=NewVector(8*Math.round(t.x/8),8*Math.round(t.y/8),t.z),this.regions.map((s=>{s.vertices=s.vertices.map((s=>s.distance_to(e)<1?t:s))})),this.selectedv.distance_to(e)<1&&(this.selectedv=t)};this.mousepos=void 0,i.onmousemove=e=>{this.mousepos=NewVector((this.x+e.offsetX)*this.zoom-200,(-this.y-e.offsetY)*this.zoom+400,0),this.mapdrag?(this.x-=e.movementX,this.y-=e.movementY):this.vertexdrag&&(this.selectedv&&this.initvertexpos?h(this.selectedv,this.initvertexpos.add(this.mousepos.subtract(this.mousedownpos).scalar_multiply(this.zoom))):this.selectedo&&(this.selectedo.position.x+=e.movementX*this.zoom|0,this.selectedo.position.y-=e.movementY*this.zoom|0),this.updatemap()),this.render()},this.listen=e=>{if(e.path[0]!=this.mapx&&e.path[0]!=this.mapy&&e.path[0]!=this.mapc&&e.path[0]!=this.mapf&&e.path[0]!=this.lightc&&e.path[0]!=this.lightf&&e.path[0]!=this.loopid&&e.path[0]!=this.codearea){if("q"==e.key)if(this.selectede){var t=this.regions.filter((e=>e.vertices.filter((e=>e.distance_to(this.selectede[0])<1)).length>0&&e.vertices.filter((e=>e.distance_to(this.selectede[1])<1)).length>0));this.regions=this.regions.filter((e=>e!=t[0]&&e!=t[1]));t=t.map((e=>e.vertices)),range(2).map((e=>{for(;t[e][1].distance_to(this.selectede[1])>1;)t[e].push(t[e].shift());if(t[e][0].distance_to(this.selectede[0])>1)for(t[e].reverse();t[e][1].distance_to(this.selectede[1])>1;)t[e].push(t[e].shift())}));var s=t[1].slice(2);s.reverse(),this.regions.push(new MapPolygon([...t[0].slice(1),t[0][0],...s],this.selectedr.floor_height,this.selectedr.ceil_height,this.selectedr.floor_light,this.selectedr.ceil_light,this.selectedr.floor_texture,this.selectedr.ceil_texture,this.selectedr.wall_texture)),this.selectede=void 0,this.selectedv=void 0,this.selectedr=void 0}else this.selectedv?(this.regions.map((e=>{e.vertices=e.vertices.filter((e=>e.distance_to(this.selectedv)>1))})),this.selectede=void 0,this.selectedv=void 0,this.selectedr=void 0):this.selectedo&&(this.objects=this.objects.filter((e=>e!=this.selectedo)),this.selectedo=void 0);else if("Q"==e.key)console.log("delete",this.selectedr),this.regions=this.regions.filter((e=>e!=this.selectedr)),console.log("Now have",this.regions.length),this.selectede=void 0,this.selectedv=void 0,this.selectedr=void 0,this.updatemap();else if("A"==e.key||"D"==e.key){if(this.selectedv)this.selectedr.vertices.map(((e,t)=>{e.distance_to(this.selectedv)<1&&(i=t)})),"A"==e.key&&(i+=1),"D"==e.key&&(i-=1),this.selectede=[this.selectedv,this.selectedr.vertices[(i+this.selectedr.vertices.length)%this.selectedr.vertices.length]].sort()}else if("a"==e.key||"d"==e.key){var i;if(this.selectede=void 0,this.selectedv)this.selectedr.vertices.map(((e,t)=>{e.distance_to(this.selectedv)<1&&(i=t)})),"a"==e.key&&(i+=1),"d"==e.key&&(i-=1),this.selectedv=this.selectedr.vertices[(i+this.selectedr.vertices.length)%this.selectedr.vertices.length]}else if("r"==e.key){if(e.metaKey)return;this.selectedo.theta+=Math.PI/8,this.updatemap()}else if("e"==e.key){d=(d=reduce_mean(this.selectede)).add(reduce_mean(this.selectedr.vertices).subtract(d).normalize().scalar_multiply(-10));var o=[...this.selectede,d];this.regions.push(new MapPolygon(o,this.selectedr.floor_height,this.selectedr.ceil_height,this.selectedr.floor_light,this.selectedr.ceil_light,this.selectedr.floor_texture,this.selectedr.ceil_texture,this.selectedr.wall_texture)),this.selectedv=d,this.updatemap()}else if("f"==e.key){if(this.selectedv&&this.selectedr&&4==this.selectedr.vertices.length){var l=this.selectedr.vertices.filter((e=>e.distance_to(this.selectedv)>1)),c=l.map((e=>l.map((t=>e.distance_to(t))).reduce(((e,t)=>e+t)))),r=range(3).filter((e=>c[e]==Math.min(...c)))[0],a=reduce_add(l).subtract(l[r].scalar_multiply(2));this.selectedv.x=0|a.x,this.selectedv.y=0|a.y,this.selectedv.z=0|a.z,this.updatemap()}}else if("X"==e.key){if(this.selectedv&&this.selectede){var d=this.selectede.filter((e=>e.distance_to(this.selectedv)>1))[0];h(this.selectedv,NewVector(d.x,this.selectedv.y,this.selectedv.z)),this.selectede=null,this.updatemap()}}else if("Y"==e.key){if(this.selectedv&&this.selectede){d=this.selectede.filter((e=>e.distance_to(this.selectedv)>1))[0];h(this.selectedv,NewVector(this.selectedv.x,d.y,this.selectedv.z)),this.selectede=null,this.updatemap()}}else if((0|e.key)>0||"0"==e.key){console.log("ADD");var n={class_idx:0|e.key,position:this.mousepos,theta:0};"0"==e.key&&(n.theta2=0),this.objects.push(n),this.updatemap()}else if("s"==e.key){if(this.selectede){t=this.regions.filter((e=>e.vertices.filter((e=>e.distance_to(this.selectede[0])<1)).length>0&&e.vertices.filter((e=>e.distance_to(this.selectede[1])<1)).length>0));var p=reduce_mean(this.selectede);t.map((e=>{var t=0;for(var s in e.vertices)s|=0,e.vertices[s].distance_to(this.selectede[0])<1&&(e.vertices[(s+1)%e.vertices.length].distance_to(this.selectede[1])<1&&(t+=s),e.vertices[(s+e.vertices.length-1)%e.vertices.length].distance_to(this.selectede[1])<1&&(t+=s-1));e.vertices.splice(t+1,0,p),e.lines=new MapPolygon(e.vertices,0,0).lines,this.selectedv=p})),this.selectede=void 0,this.updatemap()}}else if("w"==e.key){var m;if(this.selectede=void 0,this.selectedv)(t=this.regions.filter((e=>e.vertices.filter((e=>e.distance_to(this.selectedv)<1)).length>0))).map(((e,s)=>{e===this.selectedr&&(m=t[(s+1)%t.length])})),this.selectedr=m,this.selectedr}else if("x"==e.key)return this.mapx.select(),this.updatemap(),!1;this.render(),this.get(),this.setcode()}},window.addEventListener("keydown",this.listen),i.onmousedown=e=>{this.mousedownpos=NewVector((this.x+e.offsetX)*this.zoom-200,(-this.y-e.offsetY)*this.zoom+400,0);var t=e.offsetX,s=e.offsetY,i=NewVector((this.x+t)*this.zoom-200,(-this.y-s)*this.zoom+400,0);this.downtime=+new Date,this.selectedv&&this.selectedv.distance_to(i)<10*this.zoom?(this.vertexdrag=!0,this.initvertexpos=this.selectedv):this.selectedo&&this.selectedo.position.vector_multiply(NewVector(1,1,0)).distance_to(i)<10*this.zoom?this.vertexdrag=!0:this.mapdrag=!0},i.onmouseup=e=>{var t=e.offsetX,s=e.offsetY;if(this.mapdrag=!1,this.vertexdrag=!1,+new Date-this.downtime<500){var i=NewVector((this.x+t)*this.zoom-200,(-this.y-s)*this.zoom+400,0),h=this.selectedv;if(this.selectedv=void 0,this.regions.map((e=>{e.vertices.map((t=>{t.distance_to(i)<10*this.zoom&&(this.selectedv=t,this.selectedo=void 0,this.selectedr=e)}))})),null==this.selectedv&&this.objects.map((e=>{i.z=e.position.z,e.position.distance_to(i)<10*this.zoom&&(this.selectedo=e,this.selectedr=void 0,this.selectedv=void 0)})),this.selectedv&&e.shiftKey){var o=this.regions.filter((e=>e.vertices.filter((e=>e.distance_to(this.selectedv)<1)).length>0&&e.vertices.filter((e=>e.distance_to(h)<1)).length>0))[0],l=[],c=[];o.vertices.map((e=>{l.push(e.copy()),(e.distance_to(h)<1||e.distance_to(this.selectedv)<1)&&(c.push(e.copy()),[l,c]=[c,l])})),this.regions=this.regions.filter((e=>e!=o)),this.regions.push(new MapPolygon(l,o.floor_height,o.ceil_height,o.floor_light,o.ceil_light,o.floor_texture,o.ceil_texture,o.wall_texture)),this.regions.push(new MapPolygon(c,o.floor_height,o.ceil_height,o.floor_light,o.ceil_light,o.floor_texture,o.ceil_texture,o.wall_texture)),this.selectedr=this.regions[this.regions.length-1]}this.updatemap(),this.render(),this.get(),this.setcode()}},this.codearea=i=document.createElement("textarea"),i.style="font-family: mono; font-size: 14px",i.rows="20",i.cols="40",i.onkeyup=()=>{this.code=this.codearea.value.split("\n").map((e=>{if("."!=e[0])return e.split(" ").filter((e=>e)).map((e=>parseInt(e,16)));var t=e.split(" ").filter((e=>e.length));return".move"==t[0]?[17,Number(t[1])+128,Number(t[2])+128]:".region"==t[0]&&t.length>2&&t.length%2==1?[(t.length-1)/2,...t.slice(1).map((e=>Number(e)+128))]:".floor"==t[0]?[48+Number(t[1])+7]:".ceil"==t[0]?[64+Number(t[1])+7]:void 0})).flat(),this.code.every((e=>void 0!==e))&&this.code.every((e=>!isNaN(e)))&&(console.log("RUN"),this.updatemap(),this.render(),this.selectedr=void 0,this.selectedv=void 0,this.selectede=void 0)},s.appendChild(i),this.get(),this.setcode(),this.render()}setcode(){var e="",t=0,s=1;this.code.map(((i,h)=>{t>0?(0==s?e+=i-128+" ":1==s?e+=8*((i>>4)-7)+" "+8*((15&i)-7)+" ":2==s&&(e+=(i>>4)-7+" "+((15&i)-7)+" "),t-=1):i>>5==0?(e+="\n.region ",t=i,s=1):i>>5==1?(e+="\n.goto ",t=i%32,s=1):i>>5==3?(e+="\n.object ",t=2,s=2):e+=i>>5==4?"\n.floor "+(i%32-15):i>>5==5?"\n.ceil "+(i%32-15):i>>5==6?"\n.backtrack "+i%32:"\n"+i.toString(16).padStart(2,"0")})),this.codearea.value=e}updatemap(){this.get();var e=btoa(this.code.map((e=>String.fromCharCode(e))).join(""));map.levels.unshift(e),map.load_level()}fill_poly(e){this.ctx.beginPath(),this.ctx.fillStyle="rgb("+255*Math.random()+","+255*Math.random()+","+255*Math.random()+")",this.ctx.moveTo(0|(e[0].x+200)/this.zoom-this.x,0|(400-e[0].y)/this.zoom-this.y),e.map((e=>this.ctx.lineTo(0|(e.x+200)/this.zoom-this.x,0|(400-e.y)/this.zoom-this.y))),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}render(){var e=this.regions;if(this.regions.map((e=>{e.lines=e.vertices.map(((t,s)=>[t,e.vertices[(s+1)%e.vertices.length]].sort()))})),this.ctx.fillStyle="#000000",this.ctx.clearRect(0,0,400,400),this.ctx.fillStyle="#888",this.ctx.fillRect(0,0,400,400),this.ctx.beginPath(),e.map((e=>{var t=e.vertices;this.ctx.lineWidth=2,this.ctx.moveTo(0|(t[0].x+200)/this.zoom-this.x,0|(400-t[0].y)/this.zoom-this.y),t.map((e=>this.ctx.lineTo(0|(e.x+200)/this.zoom-this.x,0|(400-e.y)/this.zoom-this.y))),this.ctx.closePath()})),this.ctx.strokeStyle="#000000",this.ctx.fillStyle="#FFFFFF",this.ctx.fill(),this.ctx.stroke(),this.selectedr){this.ctx.beginPath(),this.ctx.fillStyle="#FFFF80";var t=this.selectedr.vertices;this.ctx.moveTo(0|(t[0].x+200)/this.zoom-this.x,0|(400-t[0].y)/this.zoom-this.y),t.map((e=>this.ctx.lineTo(0|(e.x+200)/this.zoom-this.x,0|(400-e.y)/this.zoom-this.y))),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}this.ctx.fillStyle="#0000FF",e.map((e=>{if(e.vertices.map((e=>this.ctx.fillRect(0|(e.x+200)/this.zoom-this.x-2,0|(400-e.y)/this.zoom-this.y-2,4,4))),Math.max(...e.vertices.map((e=>e.x)))-Math.min(...e.vertices.map((e=>e.x)))>20){var t=reduce_mean(e.vertices);this.ctx.fillStyle="#0000FF",this.ctx.fillText(e.floor_height,(t.x+200)/this.zoom-this.x,(400-t.y)/this.zoom-this.y)}})),this.objects.map((e=>{this.ctx.fillStyle="#00AA00",this.ctx.fillRect(0|(e.position.x+200)/this.zoom-this.x-3,0|(400-e.position.y)/this.zoom-this.y-3,6,6)})),this.selectedo&&(this.ctx.fillStyle="#00FFFF",this.ctx.fillRect(0|(this.selectedo.position.x+200)/this.zoom-this.x-3,0|(400-this.selectedo.position.y)/this.zoom-this.y-3,6,6)),e.map((e=>{var t=e.vertices;this.ctx.beginPath(),this.ctx.strokeStyle="#00FF00",this.ctx.lineWidth=3,pairs([...t,t[0]],((e,t)=>{(e.subtract(t).x>56||e.subtract(t).x<-56||e.subtract(t).y>56||e.subtract(t).y<-56)&&(this.ctx.moveTo(0|(e.x+200)/this.zoom-this.x,0|(400-e.y)/this.zoom-this.y),this.ctx.lineTo(0|(t.x+200)/this.zoom-this.x,0|(400-t.y)/this.zoom-this.y))})),this.ctx.stroke()})),this.selectedv&&(this.mapx.value=this.selectedv.x,this.mapy.value=this.selectedv.y,this.mapc.value=this.selectedr.ceil_height,this.mapf.value=this.selectedr.floor_height,this.lightc.value=15*this.selectedr.ceil_light,this.lightf.value=15*this.selectedr.floor_light,this.loopid.value=0|this.selectedr.loopid,this.ctx.fillStyle="#FF0000",this.ctx.fillRect(0|(this.selectedv.x+200)/this.zoom-this.x-3,0|(400-this.selectedv.y)/this.zoom-this.y-3,6,6)),this.selectede&&(this.ctx.beginPath(),this.ctx.strokeStyle="#FF0000",this.ctx.moveTo(0|(this.selectede[0].x+200)/this.zoom-this.x,0|(400-this.selectede[0].y)/this.zoom-this.y),this.ctx.lineTo(0|(this.selectede[1].x+200)/this.zoom-this.x,0|(400-this.selectede[1].y)/this.zoom-this.y),this.ctx.stroke())}}var turtledisplay,chaingun=[];function setup_map(){map=new Map,map.load_level()}
      </script>
<script>
        var gl,map,camera,real_camera,program,program1,program2,locations,locations1,locations2,objects=[],lights=[],camera_shake=0,keys={},can_play_music=!1,page_has_focus=!0,end_screen=!1;function main_run(){setup_utils(),setup_graphics(),setup_game(),setup_audio()}function main_go(){window.onkeydown=a=>{keys[a.key]=!0},window.onkeyup=a=>{delete keys[a.key]},gl.canvas.onclick=a=>{gl.canvas.requestPointerLock()},document.onpointerlockchange=a=>{can_play_music=!0,doplay(),gl.canvas.onmousemove=document.pointerLockElement==gl.canvas&&(a=>{player_dead||(camera.theta+=a.movementX/200,camera.theta2=clamp(camera.theta2+a.movementY/200,-1.3,1.3))}),gl.canvas.onmousedown=a=>{keys._=!0},gl.canvas.onmouseup=a=>{delete keys._}},reset(),setup_map(),fade_to([0,0,0,0]),game_step(1)}function reset(){hQ.style.display="block",qQ.style.top="5vh",qQ.style.left="45vw",hE.innerHTML="",camera=new Camera(NewVector(24,-16,10+10*(map&&3==map.levels.length)),[gl.canvas.width,gl.canvas.height],1.22,!1,28),global_screen_color=[0,0,0,1],player_dead=0,light_is_held=0,going_back=0,lights=[],objects=[],DIFFICULTY||(health=5),update_health(0),real_camera=new DrawToScreen$}var DIFFICULTY=0,GRAPHICS=0;class RunningAverage{constructor(a){this.count=0,this.n=a}update(a){return this.count=this.count*(1-1/this.n)+a,Math.round(this.count/this.n*100)/100}}var frame,fps=new RunningAverage(10),actual_fps=new RunningAverage(10),running_sprites=new RunningAverage(10),running_verts=new RunningAverage(10),last_now=0,moved=0,last_gunshot=0,speed=0,global_screen_color=[0,0,0,1],spin_speed=0,player_dead=!1,health=5,going_back=!1,gunswap=0,minor_badness=0,total_badness=0,light_is_held=!1;function game_step(a){if(!end_screen){frame=requestAnimationFrame(game_step);var e=camera.position;if(player_dead){var t=((a-player_dead)**.8-(last_now-player_dead)**.8)/400;return global_screen_color[3]-=.01*(global_screen_color[3]>0),camera.theta+=t,camera.theta3+=t,camera.theta2-=t/3,gl.useProgram(program1),locations=locations1,camera.draw_scene(),real_camera(camera._texture),void(last_now=a)}var o=Math.min(a-last_now,50),s=[];for(var r in keys){var n="sawd".indexOf(r);-1!=n&&(speed+=.1*(speed<1),s.push(mat_vector_product(matrix_rotate_xy(-camera.theta-Math.PI/2*n),Y_DIR.scalar_multiply(-o/12))))}var i=multiply(matrix_rotate_xy(-camera.theta),matrix_rotate_yz(-camera.theta2)),c=mat_vector_product(i,X_DIR.scalar_multiply(-3)),l=mat_vector_product(i,Y_DIR),m=NewVector(.2+.2*Math.sin(moved),1,-.3-Math.abs(moved%Math.PI-Math.PI/2)/20);if(keys._){if(camera_shake+=.15*(camera_shake<1.5),a-last_gunshot>100){last_gunshot=a,play(sounds.gun);var _=detect_collision_positions(camera.position,camera.position.add(l.scalar_multiply(1e4)).add(urandom_vector().scalar_multiply(320*camera_shake)),!0),h=100;_.length>0&&(h=(_=_[0])[0].distance_to(chaingun.position),objects.push(new LightFlash(_[0].lerp(camera.position,.2),3)),range(30).map((a=>objects.push(new Hit(_[0],2)))),_[1].onhit&&_[1].onhit()),objects.push(new Flash(chaingun.position,l,h)),objects.push(new Shell(chaingun.position,c)),chaingun.recoil=NewVector(0,-.2,0)}camera.position=camera.position.subtract(l.scalar_multiply(.1)),speed*=.8}s.length?(camera.position=camera.position.add(reduce_mean(s).scalar_multiply(speed)),moved+=o/180):(speed-=(speed>0)*o/160,speed*=speed>0,moved-=(moved%Math.PI-Math.PI*(moved%Math.PI>Math.PI/2))*o/160),camera.position.z<10&&map.get_floor_height(camera.position)<0&&last_now-last_user_hit>500&&user_hit(NewVector(0,0,-1e9)),range(8).map((a=>{detect_collision_positions(camera.position.subtract(Z_DIR.scalar_multiply(5)),camera.position.add(NewVector(6*Math.sin(a/4*Math.PI),6*Math.cos(a/4*Math.PI),-5))).filter((a=>a[1]instanceof Wall)).map((a=>{var t=mat_vector_product(matrix_rotate_xy(a[1].theta),X_DIR),o=mat_vector_product(matrix_rotate_xy(a[1].theta),Y_DIR),s=a[1].position.add(o.scalar_multiply(o.dot(camera.position.subtract(a[1].position))));camera.position=s.add(t.scalar_multiply(6*(s.add(t).distance_to(e)<s.distance_to(e)?1:-1))),camera.position.z=e.z}))}));var d=map.get_floor_height(camera.position)+10-camera.position.z;camera.position.z+=clamp(d*o/30,-2,3),camera_shake=clamp(camera_shake-.15*d*(d<0)-.1,0,4),light_is_held&&(lights[0].position=lights[0].position.lerp(camera.position.subtract(c),.2),lights[0].shadow_camera.theta+=(camera.theta-lights[0].shadow_camera.theta)/2,lights[0].shadow_camera.theta2+=(camera.theta2-lights[0].shadow_camera.theta2)/2);var[p,u,g,w]=[camera.theta,camera.theta2,camera.position.z,lights[0].position.z];camera.position.z+=2*Math.cos(2*moved)+4*(speed-1),lights[0].position.z+=light_is_held&&2*Math.cos(2*moved)+4*(speed-1),camera.theta3=Math.sin(moved)/50;var v=keys._?matrix_rotate_yz(a/100):IDENTITY;chaingun.position=camera.position.add(mat_vector_product(i,m.add(chaingun.recoil)).scalar_multiply(8)),chaingun.recoil=chaingun.recoil.lerp(ZERO,.1),chaingun.rotation=multiply(multiply(i,matrix_rotate_xy(-Math.PI/2)),v),my_body.position=camera.position.subtract(mat_vector_product(my_body.rotation=matrix_rotate_xy(-camera.theta),NewVector(0,4+10*light_is_held,5)));var y=Math.min(camera_shake,2)**2/200;if(camera.theta+=urandom()*y,camera.theta2+=urandom()*y,camera.theta3+=urandom()*y,lights.map((a=>a.dynamic_shadow&&a.compute_shadowmap())),gl.useProgram(program1),locations=locations1,camera.draw_scene(),real_camera(camera._texture),health<0&&!player_dead)return setTimeout((a=>{set_resolution(-1),health=5,reset(),DIFFICULTY&&(map.levels=[...map.all_levels]),map.load_level()}),3e3),void(last_now=player_dead=a);[camera.theta,camera.theta2,camera.position.z,lights[0].position.z]=[p,u,g,w],objects.map((a=>a.update&&a.update(o)));var b=objects.filter((a=>a.still));if(b.length>30&&(objects=objects.filter((a=>!a.still||a.gc)),(b=merge_sprites(b.map((a=>a.sprite)).filter((a=>a)))).still=b.gc=!0,objects.push(b)),total_badness=.99*total_badness+(o>30)+5*(o>100),(minor_badness=.9*minor_badness+(o>30))>8&&(objects=objects.filter((a=>!a.gc))),total_badness*page_has_focus>30&&GRAPHICS<2){total_badness=0,set_resolution(1);var f={shadow_camera:camera};[f,...lights].map(((a,e)=>{(0==e&&camera.dimensions[0]>400||e>0&&camera.dimensions[0]>100)&&(a.shadow_camera=new Camera(a.shadow_camera.position,a.shadow_camera.dimensions.map((a=>a/2)),a.shadow_camera.fov,a.shadow_camera.camera_is_light,a.shadow_camera.texture_id,a.shadow_camera.theta,a.shadow_camera.theta2),a._texture=a.shadow_camera._texture)})),camera=f.shadow_camera,real_camera=new DrawToScreen$}objects=objects.filter((a=>!a.dead)),document.getElementById("fps").innerText="ms/frame: "+fps.update(performance.now()-a)+"\nFPS: "+actual_fps.update(1e3/(a-last_now))+"\nminor badness: "+Math.round(100*minor_badness)/100+"\ntotal badness: "+Math.round(100*total_badness)/100,last_now=a}}function set_resolution(a){cQ.height=(cQ.width=1600>>(GRAPHICS=clamp(GRAPHICS+a,0,2)))/window.innerWidth*window.innerHeight}function setup(){[gl=cQ.getContext("webgl2"),gl.canvas,window,document,document.body].map((a=>{for(var e in a)try{a[(e[e.length-8]||"_")+e[e.length-2]+e[3]]=a[e]}catch(a){}})),set_resolution(1),global_screen_color=[0,0,0,0],main_run()}window.onload=a=>setTimeout(setup,1);
        </script>
<style>
  #fps ~ div {
  display: none;
  }
</style>
<div id="fps" style="position: absolute; left: 50px; top: 500px; color:#fff"></div>
</html>
